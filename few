#!/usr/bin/env ruby
require 'pathname'
require 'tempfile'
require 'cgi'

def open_browser(path)
  case RUBY_PLATFORM
  when /darwin/
    system 'open', path
  when /mswin(?!ce)|mingw|cygwin|bccwin/
    system 'start', path
  else
    system 'firefox', path
  end
end

def few
  t = Tempfile.new('few')

  File.open(t.path, 'w') do |io|
    a = ARGF.read
    a = a.gsub(/\r?\n/, "<br />\n")
    # TODO: use CSS; text-indent: xx em;
    a = a.gsub(/^\s+/) {|m| '<font color=white>' + "_"*m.size  + '</font>' }
    io.puts <<-EOF
    <html>
      <head><title>#{ARGF.filename}</title></head>
      <body>
      #{a}
      </body>
    </html>
    EOF
  end

  t.close

  File.rename(t.path, html = t.path + '.html')

  open_browser(html)
end

case $0
when __FILE__
  case ARGV[0]
  when '-h', '--help'
    puts "[USAGE]: few {filename}"
  when '-v', '--version'
    puts "0.0.1"
  else
    few
  end
when /spec[^\/]*$/
  describe 'few' do
    it 'is awesome' do
      def open_browser(path); path; end
      def ARGF.read; 'a'; end
      def ARGF.filename; 'b'; end
      few.should be_an_instance_of(String)
    end
  end
end

# vim: set filetype=ruby :
