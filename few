#!/usr/bin/env ruby
require 'pathname'
require 'tempfile'
require 'cgi'

def open_browser(path)
  case RUBY_PLATFORM
  when /darwin/
    system 'open', path
  when /mswin(?!ce)|mingw|cygwin|bccwin/
    system 'start', path
  else
    system 'firefox', path
  end
end

def few
  t = Tempfile.new('few')

  File.open(t.path, 'w') do |io|
    a = ARGF.read
    a = a.gsub(/\r?\n/, "<br />\n")

    # NOTE: Currently "&nbsp;" doesn't work on ujihisa's environment.
    #   This may be because of the font you use.

    a = CGI.escapeHTML(a)
    a = a.gsub(/^(\s+)(.+)<br \/>$/) { '<p style="text-indent: ' + ($1.size/2.0).to_s + 'em;">' + $2 + '</p>' }

    io.puts <<-EOF
    <html>
      <head>
        <title>#{ARGF.filename}</title>
        <style type="text/css">
            p { margin: 0; }
        </style>
      </head>
      <body>
      #{a}
      </body>
    </html>
    EOF
  end

  t.close

  File.rename(t.path, html = t.path + '.html')

  open_browser(html)
end

case $0
when __FILE__
  case ARGV[0]
  when '-h', '--help'
    puts "[USAGE]: few {filename}"
  when '-v', '--version'
    puts "0.0.1"
  when '--selfupdate'
    require 'open-uri'
    code = open('http://github.com/ujihisa/few/raw/master/few') {|io| io.read }
    raise unless /^#!/ =~ code
    File.open(__FILE__, 'w') {|io| io.print code }
    system __FILE__, '-v'
  else
    few
  end
when /spec[^\/]*$/
  describe 'few' do
    it 'is awesome' do
      def open_browser(path); path; end
      def ARGF.read; 'a'; end
      def ARGF.filename; 'b'; end
      few.should be_an_instance_of(String)
    end
  end
end

# vim: set filetype=ruby :
